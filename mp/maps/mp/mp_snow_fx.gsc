#include common_scripts\utility;
#include maps\mp\_utility;
main()
{
	level._effect[ "satellite_fall_child8" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_child8" );
	level._effect[ "satellite_fall_child0" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_child0" );
	level._effect[ "satellite_fall_child1" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_child1" );
	level._effect[ "satellite_fall_child2" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_child2" );
	level._effect[ "satellite_fall_child3" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_child3" );
	level._effect[ "satellite_fall_child4" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_child4" );
	level._effect[ "satellite_fall_child5" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_child5" );
	level._effect[ "satellite_fall_child6" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_child6" );
	level._effect[ "satellite_fall_child7" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_child7" );
	level._effect[ "vfx_fire_server_sov" ] 				= loadfx( "vfx/ambient/fire/electrical/vfx_fire_server_sov" );
	level._effect[ "vfx_fire_server_sov_ngonly" ] 		= loadfx( "vfx/ambient/fire/electrical/vfx_fire_server_sov_ngonly" );
	level._effect[ "vfx_snd_emt_snow_fire_small_wood2" ]= loadfx( "vfx/moments/mp_snow/vfx_snd_emt_snow_fire_small_wood2" );
	level._effect[ "satellite_fall_impact" ] 			= loadfx( "vfx/moments/mp_snow/satellite_fall_impact" );
	level._effect[ "vfx_snd_emt_snow_fire_small_wood" ] = loadfx( "vfx/moments/mp_snow/vfx_snd_emt_snow_fire_small_wood" );
	level._effect[ "vfx_snd_emt_snow_fire_med_sat_lp" ] = loadfx( "vfx/moments/mp_snow/vfx_snd_emt_snow_fire_med_sat_lp" );
	level._effect[ "embers_burst_runner_cheap" ] 		= loadfx( "vfx/moments/mp_warhawk/embers_burst_runner_cheap" );
	level._effect[ "vfx_ground_embers_mp" ] 			= loadfx( "vfx/moments/mp_snow/vfx_ground_embers_mp" );
	level._effect[ "snow_tree_impact" ] 				= loadfx( "fx/explosions/snow_tree_impact" );
	level._effect[ "snow_light_mp_oneshot" ] 			= loadfx( "fx/snow/snow_light_mp_oneshot" );
	level._effect[ "snow_sattelite_impact" ] 			= loadfx( "fx/explosions/snow_sattelite_impact" );
	level._effect[ "satellite_fall" ] 					= loadfx( "vfx/moments/mp_snow/satellite_fall_parent" );
	level._effect[ "vfx_tree_fire_stump" ] 				= loadfx( "vfx/ambient/fire/wood/vfx_tree_fire_stump" );
	level._effect[ "water_splashes_sm_runner" ]	 		= loadfx( "vfx/moments/mp_snow/water_splashes_sm_runner" );
	level._effect[ "vfx_snow_chopper_spiral" ] 			= loadfx( "vfx/ambient/weather/snow/vfx_snow_chopper_spiral" );
	level._effect[ "vfx_fireplace" ] 					= loadfx( "vfx/ambient/fire/vfx_fireplace" );
	level._effect[ "snow_door_runner" ] 				= loadfx( "fx/snow/snow_door_runner" );
	level._effect[ "snow_window_runner" ] 				= loadfx( "fx/snow/snow_window_runner" );
	level._effect[ "mp_snow_lighthouse" ] 				= loadfx( "vfx/moments/mp_snow/mp_snow_lighthouse" );
	level._effect[ "vfx_falling_dirt_cave_runner" ] 	= loadfx( "vfx/moments/mp_snow/vfx_falling_dirt_cave_runner" );
	level._effect[ "water_splashes_runner" ] 			= loadfx( "vfx/moments/mp_snow/water_splashes_runner" );
	level._effect[ "vfx_snow_trail_falling_thin" ] 		= loadfx( "vfx/ambient/weather/snow/vfx_snow_trail_falling_thin" );
	level._effect[ "snow_falling_tree_mp" ] 			= loadfx( "fx/snow/snow_falling_tree_mp" );
	level._effect[ "chimney_smoke_mp_snow" ] 			= loadfx( "fx/smoke/chimney_smoke_mp_snow" );
	level._effect[ "vfx_int_haze_mp_snow_thick" ] 		= loadfx( "vfx/ambient/atmospheric/vfx_int_haze_mp_snow_thick" );
	level._effect[ "vfx_int_haze_mp_snow" ] 			= loadfx( "vfx/ambient/atmospheric/vfx_int_haze_mp_snow" );
	level._effect[ "snow_spiral_updraft_runner" ] 		= loadfx( "vfx/ambient/weather/snow/snow_spiral_updraft_runner" );
	level._effect[ "heat_vent_mp_snow" ] 				= loadfx( "vfx/ambient/misc/heat_vent_mp_snow" );
	level._effect[ "vfx_bulb_prismatic_mp_snow" ] 		= loadfx( "vfx/ambient/lights/vfx_bulb_prismatic_mp_snow" );
	level._effect[ "vfx_fog_water_mp" ] 				= loadfx( "vfx/ambient/atmospheric/vfx_fog_water_mp" );
	level._effect[ "snow_spray_oriented_short" ] 		= loadfx( "fx/snow/snow_spray_oriented_short" );
	level._effect[ "vfx_lantern" ] 						= loadfx( "vfx/ambient/misc/vfx_lantern" );
	level._effect[ "drips_slow_10x10_mp" ] 				= loadfx( "fx/misc/drips_slow_10x10_mp" );
	level._effect[ "snow_light_mp" ] 					= loadfx( "fx/snow/snow_light_mp" );
	level._effect[ "flashlight_spotlight_mp" ] 			= loadfx( "vfx/ambient/lights/flashlight_spotlight_mp" );
	level._effect[ "vfx_light_beam_outdoor_sm_mp_snow" ]= loadfx( "vfx/ambient/lights/vfx_light_beam_outdoor_sm_mp_snow" );
	level._effect[ "vfx_light_beam_window_mp_snow2" ]	= loadfx( "vfx/ambient/lights/vfx_light_beam_window_mp_snow2" );
	level._effect[ "vfx_light_beam_window_mp_snow" ] 	= loadfx( "vfx/ambient/lights/vfx_light_beam_window_mp_snow" );
	level._effect[ "vfx_light_blink_distance_red" ] 	= loadfx( "vfx/ambient/lights/vfx_light_blink_distance_red" );
	level._effect[ "vfx_light_beam_outdoor_lg_mp_snow" ]= loadfx( "vfx/ambient/lights/vfx_light_beam_outdoor_lg_mp_snow" );
	level._effect[ "vfx_light_beam_outdoor_mp_snow" ] 	= loadfx( "vfx/ambient/lights/vfx_light_beam_outdoor_mp_snow" );
	level._effect[ "vfx_bulb_prismatic_mp_snow_flare" ] = loadfx( "vfx/ambient/lights/vfx_bulb_prismatic_mp_snow_flare" );
	level._effect[ "vfx_oilrig_fire" ]					= loadfx( "vfx/moments/mp_snow/vfx_oilrig_fire" );
	
	
	 
/#
    if ( getdvar( "clientSideEffects" ) != "1" )
        maps\createfx\mp_snow_fx::main();
#/
		
	level.snowSpeed = 1;
	level thread rampSnow();
	level thread snow();
	
	fans = GetEntArray("sn_fan","targetname");
	foreach (fan in fans)
	{
		fan thread rotateFan();
	}
	//level thread setOverlay();
}
snow()
{
    while ( true )
    {
        wait(level.snowSpeed);
        if( flag("satellite_incoming" ) )
        {
            flag_wait( "satellite_incoming" );
            wait 3;
        }
        exploder(20);
    }
} 


rampSnow()
{
	MAXIMUM_SNOW_SPEED = .39;
	MINIMUM_SNOW_SPEED = 1;
	
	if( !is_gen4() )
	{
		level.snowSpeed = MINIMUM_SNOW_SPEED; //least fx count
		return;
	}
	
	while ( true )
	{
		wait(RandomFloatRange(40,55));
		while (level.snowSpeed > MAXIMUM_SNOW_SPEED)
		{
			wait(.5);
			level.snowSpeed-=.1;
		}
		wait(RandomFloatRange(1,3));
		while (level.snowSpeed < MINIMUM_SNOW_SPEED)
		{
			wait(.5);
			level.snowSpeed+=.1;
		}
	}
}

rotateFan()
{
	self endon( "death" ); 
	while(true)
	{
		self RotateYaw(-360,5);
		wait(5);
	}
}

setOverlay()
{
	self endon("death");
	shader_name = "fullscreen_dirtylense";
    scale = 1;
    x = 0;
    y = 0;
	foreach (player in level.players)
	{
		IPrintLnBold("Starting");
		overlay = newClientHudElem( player );
	    overlay.x = x;
	    overlay.y = y;
	    
	    pos = player WorldPointToScreenPos(self.origin,65);
	    
	    overlay.x = pos[ 0 ];
	    overlay.y = pos[ 1 ];
	    
	    // Need to get actual screen width
	    overlay Setshader( shader_name, int( 100 ), int( 100 ) );
	    overlay.alignX = "center";
	    overlay.alignY = "middle";
	    overlay.sort = 1;
	    overlay.horzAlign = "center";
	    overlay.vertAlign = "middle";
	    overlay.foreground = true;
	    overlay.hidewhendead = true;
		overlay.enableHudLighting = true;
		overlay.glowcolor = (1,1,1);
		overlay.glowalpha = 1.0;
	    overlay.alpha = 1.0;
	    while(true)
	    {
	    	pos = player WorldPointToScreenPos(self.origin,65);
	    	if (IsDefined(pos))
	    	{
			    overlay.x = pos[ 0 ];
			    overlay.y = pos[ 1 ];
	    	}
		    waitframe();
	    }
	    /*
	    while(true)
	    {
	    	newAlpha = RandomFloatRange(.25,.5);
	    	transitionTime = abs(newAlpha-overlay.alpha)*5;
	    	overlay FadeOverTime(transitionTime);
	    	overlay.alpha =newAlpha;
	    	wait(transitionTime);
	    	
	    	
	    	//if (newAlpha < overlay.alpha)
	    	//{
	    	//	while (newAlpha < overlay.alpha)
	    	//	{
	    	//		overlay.alpha -=.01;
			//		overlay.glowalpha = overlay.alpha;
	    	//		waitframe();
	    	//	}
	    	//}
	    	//else if (newAlpha > overlay.alpha)
	    	//{
	    	//	while (newAlpha > overlay.alpha)
	    	//	{
	    	//		overlay.alpha +=.01;
			//		overlay.glowalpha = overlay.alpha;
	    	//		waitframe();
	    	//	}
	    	//}
	    	//waitframe();
	    }*/
	}
}
